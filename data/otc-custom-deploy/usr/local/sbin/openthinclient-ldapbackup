#!/bin/bash
# Filename:     openthinclient-ldapbackup
# Purpose:      openthinclient automatic ldap backup for the openthinclient VM
# ------------------------------------------------------------------------------

LOGGER=$(which logger)

# to have the password

PWFILE=/opt/openthinclient/server/default/conf/props/openthinclient.properties
if [ -d $PWFILE ]; then
    . /opt/openthinclient/server/default/conf/props/openthinclient.properties
else
    ContextSecurityCredentials="0pen%TC"
fi

# define backup directory
BUDIR=/var/backups/openthinclient
[ ! -d $BUDIR ] && mkdir -p $BUDIR

# generate name of backup file
FILENAME=$BUDIR/otc-ldapbackup-`date +%d.%m.%y_%H-%M`.ldiff

ldapsearch -p 10389 -h localhost -x -b ou=openthinclient,dc=openthinclient,dc=org -D cn=administrator,ou=users,ou=openthinclient,dc=openthinclient,dc=org -w${ContextSecurityCredentials} > $FILENAME || $LOGGER -p info "Automatic openthinclient LDAP backup failed"

# delete backup files older than 100 days
find $BUDIR  -mtime +100 -exec rm {} \;
